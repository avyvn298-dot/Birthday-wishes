<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Abdullah's 17th Birthday Quest — Pixel Edition</title>
<style>
  :root{
    --bg1:#071223; --bg2:#0d2a3a; --ui:#dff6ff; --accent:#ff6f61;
    --pixel-font: "Courier New", monospace;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ui);font-family:var(--pixel-font);}
  .wrap{max-width:920px;margin:12px auto;padding:12px;text-align:center;}
  .title{font-size:20px;margin-bottom:6px;letter-spacing:1px}
  .dialogue-box{
    width: min(820px, 96%); margin: 6px auto; background: rgba(8,8,8,0.85); border:4px solid #071826;
    padding:16px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); font-size:18px; line-height:1.4; border-radius:8px; text-align:left;
  }
  .dialogue-text{min-height:56px;white-space:pre-wrap;font-family:var(--pixel-font);font-size:18px;color:var(--ui)}
  .choices{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}
  .btn{ background:var(--accent); color:#fff; padding:8px 12px; border-radius:6px; border:none; cursor:pointer; font-weight:700;
    box-shadow: 0 3px 0 rgba(0,0,0,0.3); }
  .btn:active{transform:translateY(1px)}
  canvas{display:block;margin:12px auto;border:4px solid #072733;background:#06121a;border-radius:8px}
  .hud{display:flex;justify-content:space-between;align-items:center;max-width:820px;margin:6px auto;color:var(--ui);font-weight:700}
  .message-float{ position:fixed;left:50%;transform:translateX(-50%);top:18%;
    background:rgba(255,255,255,0.06);padding:8px 12px;border-radius:8px;border:2px solid rgba(255,255,255,0.06);
    font-family:var(--pixel-font);font-size:16px;pointer-events:none;opacity:0;transition:opacity .2s;}
  .hidden{display:none}
  .controls{display:flex;gap:8px;align-items:center}
  .mutebtn{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--ui);padding:6px 8px;border-radius:6px;cursor:pointer}
  @media (max-width:460px){ .dialogue-text{font-size:16px} .title{font-size:18px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">🎮 Abdullah's 17th Birthday Quest — Pixel Edition</div>

    <div id="dialogue" class="dialogue-box" aria-live="polite">
      <div id="dialogueText" class="dialogue-text"></div>
      <div id="dialogueChoices" class="choices"></div>
      <div style="margin-top:8px;text-align:right"><button id="clickToContinue" class="btn hidden" aria-hidden="true">Continue</button></div>
    </div>

    <div class="hud hidden" id="hud">
      <div id="status">Name: <strong id="playerName">Abdullah Naveed</strong></div>
      <div id="score">Score: 0 / 17</div>
      <div class="controls">
        <button id="muteBtn" class="mutebtn">🔊 Music: On</button>
      </div>
    </div>

    <canvas id="game" width="420" height="600" class="hidden" aria-label="Birthday game canvas"></canvas>

    <div id="finalBox" class="dialogue-box hidden" style="text-align:center">
      <div id="finalText" style="font-size:20px;font-weight:900"></div>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap">
        <button id="replayBtn" class="btn">Play Again</button>
        <button id="downloadCert" class="btn">Download Certificate</button>
      </div>
    </div>
  </div>

  <div id="floatMsg" class="message-float" role="status"></div>

<script>
/* ===========================
   CONFIG
   =========================== */
const NAME = "Abdullah Naveed";
const TARGET_SCORE = 17;
const PLAYER_COLORS = { skin: "#f0d6b6", hair: "#2b1a0e", shirt: "#2a9df4", pants: "#222", shoe:"#111" };
const CANVAS_BASE_W = 420;
/* =========================== */

/* Dialogue script */
const script = [
  { type: "text", text: `Hi ${NAME}.` },
  { type: "text", text: `I know it's your birthday today 🎂` },
  {
    type: "choice",
    text: "Do you want your present?",
    choices: [
      { label: "Yes!", reply: "Bold move! We'll see if you deserve it..." },
      { label: "Nope", reply: "Not in the mood? Still, prove yourself anyway."},
      { label: "Let me think", reply: "Thinking? Good—decisions need quests."}
    ]
  },
  { type: "text", text: "First, a little challenge to prove you're the legend." },
  { type: "text", text: `Collect ${TARGET_SCORE} gifts and cakes to unlock your surprise!` },
  { type: "action", label: "Start Quest" }
];

/* Dialogue system */
const dialogueEl = document.getElementById("dialogue");
const textEl = document.getElementById("dialogueText");
const choicesEl = document.getElementById("dialogueChoices");
const clickContinue = document.getElementById("clickToContinue");
const hud = document.getElementById("hud");
const scoreEl = document.getElementById("score");
const playerNameEl = document.getElementById("playerName");
playerNameEl.textContent = NAME;

let scriptIndex = 0, typingTimer = null, charI = 0, isTyping = false;

function showNextScript() {
  choicesEl.innerHTML = "";
  clickContinue.classList.add("hidden");
  if (scriptIndex >= script.length) return;
  const node = script[scriptIndex++];

  if (node.type === "text") {
    typeText(node.text, () => {
      clickContinue.classList.remove("hidden");
      clickContinue.onclick = () => { clickContinue.classList.add("hidden"); showNextScript(); };
    });
  } else if (node.type === "choice") {
    typeText(node.text, () => {
      node.choices.forEach(c=>{
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = c.label;
        b.onclick = () => {
          showFloatMessage(c.reply);
          typeText(c.reply, ()=> {
            setTimeout(()=>{ showNextScript(); }, 600);
          }, true);
        };
        choicesEl.appendChild(b);
      });
    });
  } else if (node.type === "action") {
    const b = document.createElement("button");
    b.className = "btn";
    b.textContent = node.label;
    b.onclick = startGameUI;
    choicesEl.appendChild(b);
  }
}

function typeText(txt, done, override=false) {
  if (isTyping && !override) return;
  isTyping = true;
  textEl.textContent = "";
  charI = 0;
  const speed = 16;
  clearInterval(typingTimer);
  typingTimer = setInterval(()=>{
    textEl.textContent += txt[charI++] || "";
    if (charI >= txt.length) {
      clearInterval(typingTimer);
      isTyping = false;
      if (done) done();
    }
  }, speed);
}

function showFloatMessage(msg, t=1400) {
  const el = document.getElementById("floatMsg");
  el.textContent = msg;
  el.style.opacity = 1;
  clearTimeout(el._t);
  el._t = setTimeout(()=>{ el.style.opacity = 0; }, t);
}

showNextScript();

/* ==========================
   CANVAS + PIXEL SPRITES
   ========================== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha: false });
let scale = 3; // pixel scale

function fitCanvas() {
  const maxW = Math.min(window.innerWidth * 0.94, 820);
  canvas.width = Math.floor(Math.min(maxW, 560));
  canvas.height = Math.floor(canvas.width * 1.35);
  // scale relative to base sprite sizes
  scale = Math.max(2, Math.floor(canvas.width / CANVAS_BASE_W * 3));
}
window.addEventListener("resize", () => { fitCanvas(); drawStatic(); });
fitCanvas();

/* sprite draw helper */
function drawPixel(sprite, palette, x, y) {
  for (let yy=0; yy<sprite.length; yy++){
    for (let xx=0; xx<sprite[0].length; xx++){
      const v = sprite[yy][xx];
      if (!v) continue;
      ctx.fillStyle = palette[v];
      ctx.fillRect(x + xx*scale, y + yy*scale, scale, scale);
    }
  }
}

/* ---- Sprites (bigger, clearer) ----
   hero 16x16 (pixel portrait + body)
   gift 8x8, cake 8x7, book 8x6 (distinct shapes) */
const heroSprite = [
  /* head and hair */
  [0,0,0,0,2,2,2,2,2,2,0,0,0,0,0,0],
  [0,0,0,2,2,2,2,2,2,2,2,2,0,0,0,0],
  [0,0,3,3,1,1,1,1,1,1,1,3,3,0,0,0],
  [0,3,1,1,1,1,1,1,1,1,1,1,3,0,0,0],
  [0,3,1,1,1,1,1,1,1,1,1,1,3,0,0,0],
  [0,3,1,1,1,1,1,1,1,1,1,1,3,0,0,0],
  [0,0,3,3,1,1,1,1,1,1,1,3,3,0,0,0],
  /* neck / shirt */
  [0,0,0,0,4,4,4,4,4,4,4,0,0,0,0,0],
  [0,0,0,0,4,4,4,4,4,4,4,0,0,0,0,0],
  [0,0,0,0,4,4,4,4,4,4,4,0,0,0,0,0],
  /* body */
  [0,0,0,0,4,4,4,4,4,4,4,0,0,0,0,0],
  [0,0,0,0,4,4,4,4,4,4,4,0,0,0,0,0],
  [0,0,0,0,4,4,4,4,4,4,4,0,0,0,0,0],
  [0,0,0,0,5,5,0,0,0,5,5,0,0,0,0,0],
  [0,0,0,0,5,5,0,0,0,5,5,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
];

const giftSprite = [
  [0,0,6,6,6,6,0,0],
  [0,6,2,2,2,2,6,0],
  [6,2,3,3,3,3,2,6],
  [6,2,3,3,3,3,2,6],
  [6,2,3,3,3,3,2,6],
  [6,2,2,2,2,2,2,6],
  [0,6,2,2,2,2,6,0],
  [0,0,6,6,6,6,0,0]
];

const cakeSprite = [
  [0,0,0,7,7,7,0,0],
  [0,0,7,2,2,2,7,0],
  [0,7,2,3,3,2,2,7],
  [7,2,3,4,4,3,2,7],
  [7,2,3,3,3,3,2,7],
  [0,7,2,2,2,2,7,0],
  [0,0,7,7,7,7,0,0]
];

const bookSprite = [
  [0,8,8,8,8,8,8,0],
  [8,2,2,2,2,2,2,8],
  [8,2,2,2,2,2,2,8],
  [8,2,2,2,2,2,2,8],
  [8,2,2,2,2,2,2,8],
  [0,8,8,8,8,8,8,0]
];

function paletteHero(){
  return [null, PLAYER_COLORS.skin, PLAYER_COLORS.skin, PLAYER_COLORS.hair, PLAYER_COLORS.shirt, PLAYER_COLORS.pants, "#ffd500","#ffcad4","#6b8cff"];
}
const giftPalette = [null, "#fff0c8","#ffebcd","#d42f5f","#f2a654","#8b3b55","#b21"];
const cakePalette = [null, "#000","#ffe8c6","#ff6f61","#ffd29c","#fff"];
const bookPalette = [null, "#fff0c8","#cfcfcf","#8b5a4b","#2b2b2b","#000",""];

/* GAME STATE */
const player = { x: 180, y:0, vx:0, speed:4 };
let items = [], lastSpawn = 0, spawnInterval = 900, score = 0, running=false, lastTime=0, victory=false;

/* draw background */
function drawStatic(){
  // deep background
  ctx.fillStyle = "#06121a"; ctx.fillRect(0,0,canvas.width,canvas.height);
  // stars
  for (let i=0;i<30;i++){
    ctx.fillStyle = "rgba(255,255,255,0.03)";
    const sx = (i*73) % canvas.width, sy = ((i*41)+120) % (canvas.height*0.6);
    ctx.fillRect(sx, sy, 1, 1);
  }
  // ground
  ctx.fillStyle = "#071826";
  ctx.fillRect(0,canvas.height*0.78, canvas.width, canvas.height*0.22);
}

/* draw frame */
function render(){
  drawStatic();
  // draw player (center bottom)
  const heroW = heroSprite[0].length*scale, heroH = heroSprite.length*scale;
  player.drawX = Math.max(8, Math.min(canvas.width - heroW - 8, player.x));
  player.drawY = canvas.height - heroH - 38;
  drawPixel(heroSprite, paletteHero(), Math.round(player.drawX), Math.round(player.drawY));

  // draw items
  items.forEach(it=>{
    if (it.type === "gift") drawPixel(giftSprite, giftPalette, Math.round(it.x), Math.round(it.y));
    if (it.type === "cake") drawPixel(cakeSprite, cakePalette, Math.round(it.x), Math.round(it.y));
    if (it.type === "book") drawPixel(bookSprite, bookPalette, Math.round(it.x), Math.round(it.y));
  });

  // HUD text (drawn on canvas)
  ctx.fillStyle = "#dff6ff";
  ctx.font = `${12}px Courier New`;
  ctx.fillText(`Score: ${score} / ${TARGET_SCORE}`, 12, 18);
}

/* spawn items */
function spawnItem(){
  const x = Math.random() * (canvas.width - 80) + 16;
  const r = Math.random();
  let type = "gift";
  if (r > 0.86) type = "book";
  else if (r > 0.55) type = "cake";
  items.push({ x: Math.round(x), y: -40, vy: 1.2 + Math.random()*1.8, type });
  // slightly speed up spawn as score increases
  spawnInterval = Math.max(450, 900 - score * 28);
}

/* update */
function update(dt){
  player.x += player.vx * player.speed;
  player.x = Math.max(6, Math.min(player.x, canvas.width - heroSprite[0].length*scale - 6));

  if (Date.now() - lastSpawn > spawnInterval) { lastSpawn = Date.now(); spawnItem(); }

  for (let i=items.length-1;i>=0;i--){
    const it = items[i];
    it.y += it.vy * (dt/16);
    // size depending on sprite
    const iw = 8*scale, ih = (it.type==="cake"?7: (it.type==="book"?6:8))*scale;
    const px = player.drawX, py = player.drawY, pw = heroSprite[0].length*scale, ph = heroSprite.length*scale;
    if (it.y + ih >= py && it.y <= py + ph && it.x + iw >= px && it.x <= px + pw) {
      if (it.type === "gift" || it.type === "cake") {
        score = Math.min(TARGET_SCORE, score+1);
        playSfxCollect();
        pushMessage(collectMessage(score));
      } else {
        score = Math.max(0, score-1);
        playSfxHit();
        pushMessage("Ugh — a boring book! -1");
      }
      items.splice(i,1);
      scoreEl.textContent = `Score: ${score} / ${TARGET_SCORE}`;
      if (score >= TARGET_SCORE && !victory) triggerVictory();
      continue;
    }
    if (it.y > canvas.height + 30) items.splice(i,1);
  }
}

/* messages */
function collectMessage(currScore){
  const lines = ["Nice catch! One more cake coming!","Sweet! Abdullah's stash grows!","No emails today — birthday power!","Power up! Almost there!","Legendary catch!","You're a cake magnet!","Looking pro, Abdullah!"];
  return lines[currScore % lines.length];
}
function pushMessage(msg){ showFloatMessage(msg, 1300); }

/* GAME LOOP */
function loop(t){
  if (!running) return;
  const dt = t - lastTime || 16;
  lastTime = t;
  update(dt);
  render();
  if (!victory) requestAnimationFrame(loop);
}

/* Controls: keyboard + touch */
document.addEventListener("keydown",(e)=>{ if (!running) return; if (e.key==="ArrowLeft"||e.key==="a") player.vx = -1; if (e.key==="ArrowRight"||e.key==="d") player.vx = 1; });
document.addEventListener("keyup",(e)=>{ if (!running) return; if ((e.key==="ArrowLeft"&&player.vx<0)||(e.key==="ArrowRight"&&player.vx>0)||e.key==="a"||e.key==="d") player.vx = 0; });

canvas.addEventListener("pointerdown",(e)=>{ if (!running) return; const r=canvas.getBoundingClientRect(); const cx=e.clientX - r.left; player.vx = cx < canvas.width/2 ? -1 : 1; e.preventDefault(); });
canvas.addEventListener("pointerup",(e)=>{ if (!running) return; player.vx = 0; });

/* Start game UI */
function startGameUI(){
  document.getElementById("dialogue").classList.add("hidden");
  hud.classList.remove("hidden");
  canvas.classList.remove("hidden");
  document.getElementById("finalBox").classList.add("hidden");
  resetGame();
  running = true; lastTime = performance.now(); requestAnimationFrame(loop);
}
window.startGameUI = startGameUI;

/* Reset */
function resetGame(){
  items = []; lastSpawn = 0; score = 0; victory=false;
  scoreEl.textContent = `Score: ${score} / ${TARGET_SCORE}`;
  player.x = (canvas.width/2) - (heroSprite[0].length*scale)/2;
  player.vx = 0;
}

/* Victory */
function triggerVictory(){
  victory = true; running = false;
  playSfxVictory();
  setTimeout(()=>{ runFireworks(2400, ()=> {
    document.getElementById("finalText").innerHTML = `🎉 <strong>HAPPY 17th BIRTHDAY, ${NAME.toUpperCase()}</strong> 🎂<br><small style="font-weight:600">Wishing you a year of joy, success, and endless cake 🍰</small>`;
    document.getElementById("finalBox").classList.remove("hidden");
    hud.classList.add("hidden");
  }); }, 200);
}

/* Sound system: background chiptune + sfx */
let audioCtx = null, musicInterval = null, musicOn = true;
const gainNodes = { music: null, sfx: null };

function ensureAudio(){
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  gainNodes.music = audioCtx.createGain(); gainNodes.sfx = audioCtx.createGain();
  gainNodes.music.gain.value = 0.06; gainNodes.sfx.gain.value = 0.12;
  gainNodes.music.connect(audioCtx.destination); gainNodes.sfx.connect(audioCtx.destination);
}

/* chiptune loop (simple arpeggio melody) */
function startMusic(){
  if (!musicOn) return;
  ensureAudio();
  if (musicInterval) return;
  const pattern = [440, 523.25, 659.25, 587.33, 523.25, 440]; // A4, C5, E5, D5...
  let i=0;
  musicInterval = setInterval(()=>{
    const freq = pattern[i % pattern.length];
    simpleTone(freq, 0.14, 'sine', 0.0005, gainNodes.music);
    i++;
  }, 220);
}
function stopMusic(){
  clearInterval(musicInterval); musicInterval = null;
}

/* play short tone */
function simpleTone(freq=440, dur=0.1, type='square', attack=0.01, targetGain=null){
  ensureAudio();
  const ctxA = audioCtx;
  const o = ctxA.createOscillator();
  const g = ctxA.createGain();
  o.type = type; o.frequency.value = freq;
  o.connect(g); g.connect(targetGain || gainNodes.sfx);
  g.gain.setValueAtTime(0.0001, ctxA.currentTime);
  g.gain.linearRampToValueAtTime(1.0, ctxA.currentTime + attack);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001, ctxA.currentTime + dur);
  setTimeout(()=>{ try{ o.stop(); }catch(e){} }, dur*1000 + 50);
}

/* SFX wrappers */
function playSfxCollect(){ simpleTone(880 - Math.random()*180, 0.08, 'triangle'); }
function playSfxHit(){ simpleTone(220, 0.18, 'sawtooth'); }
function playSfxVictory(){ simpleTone(880, 0.22, 'square'); setTimeout(()=>simpleTone(1320,0.18,'square'),120); }

/* Mute toggle button */
const muteBtn = document.getElementById("muteBtn");
muteBtn.onclick = ()=>{
  musicOn = !musicOn;
  muteBtn.textContent = musicOn ? "🔊 Music: On" : "🔈 Music: Off";
  if (musicOn) { startMusic(); } else { stopMusic(); }
};

/* initial music start (requires user gesture in some browsers) */
document.addEventListener('pointerdown', ()=>{ if (!audioCtx) { startMusic(); } }, { once:true });

/* Fireworks */
function runFireworks(duration=2000, done){
  const particles = [];
  const centerX = canvas.width/2, centerY = canvas.height/3;
  for (let i=0;i<110;i++){
    const angle = Math.random()*Math.PI*2;
    const speed = 1 + Math.random()*5;
    particles.push({ x:centerX, y:centerY, vx:Math.cos(angle)*speed, vy:Math.sin(angle)*speed, life: 90 + Math.random()*80, color: `hsl(${Math.floor(Math.random()*360)},84%,60%)` });
  }
  const start = performance.now();
  function fw(t){
    const elapsed = t - start;
    drawStatic();
    // draw player + items behind fireworks for nice effect
    drawPixel(heroSprite, paletteHero(), Math.round(player.drawX), Math.round(player.drawY));
    items.forEach(it=>{
      if (it.type === "gift") drawPixel(giftSprite, giftPalette, Math.round(it.x), Math.round(it.y));
      if (it.type === "cake") drawPixel(cakeSprite, cakePalette, Math.round(it.x), Math.round(it.y));
      if (it.type === "book") drawPixel(bookSprite, bookPalette, Math.round(it.x), Math.round(it.y));
    });
    particles.forEach(p=>{
      p.x += p.vx; p.y += p.vy; p.vy += 0.08; p.life--;
      ctx.fillStyle = p.color; ctx.fillRect(Math.round(p.x), Math.round(p.y), 4, 4);
    });
    if (elapsed < duration) requestAnimationFrame(fw);
    else { if (done) done(); }
  }
  requestAnimationFrame(fw);
}

/* initial draw */
drawStatic();

/* Float message helper & HUD updating */
function showFloatMessage(msg, t=1400) { const el=document.getElementById("floatMsg"); el.textContent=msg; el.style.opacity=1; clearTimeout(el._t); el._t=setTimeout(()=>el.style.opacity=0,t); }
showFloatMessage("Tip: Use arrow keys or tap left/right on screen to move.",3000);

/* Start and replay bindings */
document.getElementById("replayBtn").onclick = ()=>{ document.getElementById("finalBox").classList.add("hidden"); startGameUI(); };

/* connect Start Quest (dialogue action) */
function startGameUI(){ document.getElementById("dialogue").classList.add("hidden"); hud.classList.remove("hidden"); canvas.classList.remove("hidden"); document.getElementById("finalBox").classList.add("hidden"); resetGame(); running=true; lastTime=performance.now(); if (musicOn) startMusic(); requestAnimationFrame(loop); }
window.startGameUI = startGameUI;

/* Generate & download certificate (canvas) */
document.getElementById("downloadCert").onclick = generateCertificate;

function generateCertificate(){
  // draw certificate on offscreen canvas
  const W = 1200, H = 800;
  const c = document.createElement('canvas'); c.width=W; c.height=H;
  const g = c.getContext('2d');
  // background
  g.fillStyle = "#fff9f0"; g.fillRect(0,0,W,H);
  // border
  g.strokeStyle = "#222"; g.lineWidth = 12; g.strokeRect(20,20,W-40,H-40);
  // title
  g.fillStyle = "#222"; g.font = "60px 'Courier New'"; g.textAlign="center";
  g.fillText("Certificate of Legendary Birthday", W/2, 110);
  // subtitle
  g.font = "36px 'Courier New'"; g.fillText(`Awarded to: ${NAME}`, W/2, 180);
  g.font = "28px 'Courier New'"; g.fillText(`On your 17th birthday — ${new Date().toLocaleDateString()}`, W/2, 220);
  // draw small pixel portrait on left
  const portraitX = 120, portraitY = 280, pScale = 8;
  // portrait sprite (crop head portion of heroSprite)
  const head = heroSprite.slice(0,6);
  for (let yy=0; yy<head.length; yy++){
    for (let xx=0; xx<head[0].length; xx++){
      const v = head[yy][xx];
      if (!v) continue;
      g.fillStyle = paletteHero()[v];
      g.fillRect(portraitX + xx*pScale, portraitY + yy*pScale, pScale, pScale);
    }
  }
  // message block
  g.font = "22px 'Courier New'"; g.textAlign="left";
  const lines = [
    `Happy 17th Birthday, ${NAME}!`,
    "",
    "You completed the quest and proved your legend status.",
    "May this year be filled with joy, success, and endless cake.",
    "",
    "— With love, from your friend"
  ];
  let ty = portraitY;
  for (let i=0;i<lines.length;i++){
    g.fillText(lines[i], portraitX + 240, portraitY + (i*36));
  }
  // decoration: small pixel cake at bottom-right
  // draw cake scaled
  const cakeX = W - 260, cakeY = H - 260, cakeScale = 12;
  for (let yy=0; yy<cakeSprite.length; yy++){
    for (let xx=0; xx<cakeSprite[0].length; xx++){
      const v = cakeSprite[yy][xx];
      if (!v) continue;
      g.fillStyle = cakePalette[v];
      g.fillRect(cakeX + xx*cakeScale, cakeY + yy*cakeScale, cakeScale, cakeScale);
    }
  }
  // footer
  g.textAlign="center"; g.font="18px 'Courier New'"; g.fillStyle="#444";
  g.fillText("Generated with ❤️ on GitHub Pages", W/2, H-60);

  // download
  const data = c.toDataURL("image/png");
  const a = document.createElement('a'); a.href = data; a.download = `Certificate_${NAME.replace(/\s+/g,'_')}_17.png`; document.body.appendChild(a); a.click(); a.remove();
}

/* hook initial HUD (score text updated during collisions) */
scoreEl.textContent = `Score: ${score} / ${TARGET_SCORE}`;

/* show start button in dialogue and choices rendering (already handled earlier) */
/* Expose download for convenience */
document.getElementById("playerName").textContent = NAME;

/* Safety: attempt to start audio context only after a gesture (we already listen on first pointerdown) */
document.addEventListener('pointerdown', ()=>{ if (!audioCtx && musicOn) startMusic(); }, { once:true });

/* ===========================
   Final: ensure dialog flow remains clickable
   (already wired)
   =========================== */

</script>
</body>
</html>
